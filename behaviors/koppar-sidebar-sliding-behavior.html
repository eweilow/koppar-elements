<script>
  window.Koppar = window.Koppar || {};
  window.Koppar.SlidingSidebarBehavior = {
    properties: {
      paneWidth: {
        type: Number,
        readonly: true,
        notify: true
      },

      /* Tells us when this sidebar use a max width, instead of width = (window_width - widthStep) */
      mobileBreakpointWidth: {
        type: Number,
        value: 800
      },

      tabletBreakpointWidth: {
        type: Number,
        value: 1200
      },

      mobileWidth: {
        type: Number,
        value: 280
      },

      tabletWidth: {
        type: Number,
        value: 280
      },

      desktopWidth: {
        type: Number,
        value: 320
      },

      widthStep: {
        type: Number,
        value: 56
      },

      ifOpenThenCloseAfter: {
        type: Number,
        value: 24
      },

      ifClosedThenOpenAfter: {
        type: Number,
        value: 24
      },

      rendering: {
        type: Boolean,
        reflectToAttribute: true,
        readonly: true,
        notify: true
      },

      sliding: {
        type: Boolean,
        reflectToAttribute: true,
        readonly: true,
        notify: true
      },

      _slidingIn: Boolean,
      _slidingOut: Boolean,
      _prepareSlide: Boolean,

      /* Tells us when this sidebar should fix */
      responsiveBreakpoint: {
        type: Number,
        value: 800
      },

      automaticallyAddGlobalStyles: Boolean
    },

    addGlobalStylesForBody: function() {
      var minimumBreak = Math.max(this.responsiveBreakpoint);
      var template = [
        "body {",
        "  margin: 0; padding: 0;",
        "  width: 100%;",
        "  overflow-x: hidden;",
        "  box-sizing: border-box;",
        "}",
        "@media (min-width: "+(this.responsiveBreakpoint+1)+"px) and (min-width: "+(this.tabletBreakpointWidth+1)+"px) {",
        "  body {",
        "    padding-left: "+(this.desktopWidth)+"px;",
        "  }",
        "}",
        "@media (min-width: "+(this.responsiveBreakpoint+1)+"px) and (min-width: "+(this.mobileBreakpointWidth+1)+"px) and (max-width: "+(this.tabletBreakpointWidth)+"px) {",
        "  body {",
        "    padding-left: "+(this.tabletWidth)+"px;",
        "  }",
        "}",
        "@media (min-width: "+(this.responsiveBreakpoint+1)+"px) and (max-width: "+(this.mobileBreakpointWidth)+"px) {",
        "  body {",
        "    padding-left: "+(this.mobileWidth)+"px;",
        "  }",
        "}"
      ];
      if(!this._globalStyleNode) {
        this._globalStyleNode = document.createElement("style")
        document.head.appendChild(this._globalStyleNode);
      }
      this._globalStyleNode.textContent = template.join("\n");
    },

    removeGlobalStyles: function() {
      if(!this._globalStyleNode) return;

      this._globalStyleNode.remove();
      this._globalStyleNode = null;
    },

    created: function() {
      this._boundRender = this._render.bind(this);
    },

    attached: function() {
      this.listen(window, "resize", "__onWindowResized__slide");
      this.listen(window, "touchstart", "__onTouchStart");
      this.listen(window, "touchmove", "__onTouchMove");
      this.listen(window, "touchend", "__onTouchEnd");
      this.__onWindowResized__slide();

      this.addGlobalStylesForBody();
    },

    detached: function() {
      this.unlisten(window, "resize", "__onWindowResized__slide");
      this.unlisten(window, "touchstart", "__onTouchStart");
      this.unlisten(window, "touchmove", "__onTouchMove");
      this.unlisten(window, "touchend", "__onTouchEnd");

      this.removeGlobalStyles();
    },

    listeners: {
      "touchmove": "_preventScroll"
    },
    
    _preventScroll: function(evt) {
      evt.preventDefault();
      evt.stopImmediatePropagation();
      
      this.__onTouchMove(evt);
    },

    clamp: function(t) { return Math.max(Math.min(1, t), 0); },
    easeOutQuad: function(t) { return t*(2-t) },
    _render: function() {
      if(!this.sliding) return;
      requestAnimationFrame(this._boundRender);

      
      var initialSlideInTime = 125;
      var initialSlideInDelta =
        1 - this.easeOutQuad(
          this.clamp(
            (this._slideStartTimestamp + initialSlideInTime - Date.now()) / initialSlideInTime
          )
        );
      var relativeX = (this._slideTargetPosition) - this._slidePosition;
      this._slidePosition += relativeX * initialSlideInDelta;
      this._slidePosition = Math.min(this.paneWidth, this._slidePosition);

      this.translate3d((this._slidePosition - this.paneWidth) + "px", "0", "0", this.$.pane);
      this.$.closer.style.opacity = this._slidePosition / this.paneWidth;
    },

    _calculatePaneWidth: function(windowWidth) {
      if(!windowWidth) windowWidth = 320;

      if(windowWidth < this.mobileBreakpointWidth) {
        return Math.min(windowWidth - this.widthStep, this.mobileWidth);
      } else if(windowWidth < this.tabletBreakpointWidth) { 
        return Math.min(windowWidth - this.widthStep, this.tabletWidth);
      } else {
        return Math.min(windowWidth - this.widthStep, this.desktopWidth);
      }
    },

    _shouldStartSliding: function(evt) {
      var maximumAngle = Math.PI / 6; //180 / 8 = >15 degrees
      var minLength = 25;
      var maxTimeSinceStart = 200;
      var squareMinLength = minLength * minLength;
      var deltaX = evt.changedTouches.item(0).clientX - this._startTouchX;
      var deltaY = evt.changedTouches.item(0).clientY - this._startTouchY;

      
      var angle = Math.abs(Math.atan(Math.abs(deltaY) / Math.abs(deltaX)));
      var squareLength = deltaX * deltaX + deltaY * deltaY;
      if(squareLength > 5 && angle > maximumAngle) {
        this._prepareSlide = false;
        return false;
      }
      if(this.opened && deltaX > 0) return false;
      if(!this.opened && deltaX < 0) return false;
      if(squareLength < squareMinLength) return false;
      if(Date.now() - this._startTimestamp > maxTimeSinceStart) return false;
      return true;
    },
    
    __onWindowResized__slide: function() {
      this.async(function(){
        var windowWidth = window.innerWidth;

        this.paneWidth = this._calculatePaneWidth(windowWidth);
        this.$.pane.style.width = this.paneWidth + "px";
      });
    },

    _startTimestamp: 0,
    _startTouchX: 0,
    _startTouchY: 0,
    __onTouchStart: function(evt) {
      if(this.fixed) return;

      this._prepareSlide = true;
      this._startTouchX = evt.touches[0].clientX;
      this._startTouchY = evt.touches[0].clientY;
      this._startTimestamp = Date.now();
    },

    __onTouchEnd: function(evt) {
      if(!this.sliding) return;

      this.sliding = false;
      this._slidingIn = false;
      this._slidingOut = false;
      this.$.pane.style.transform = null;
      this.$.closer.style.opacity = null;

      if(this.opened) {
        if(this._slideTargetPosition < this.paneWidth - this.ifOpenThenCloseAfter) this.close();
      } else {
        if(this._slideTargetPosition > this.ifClosedThenOpenAfter) this.open();
      }
    },

    _slidePosition: 0,
    _slideTargetPosition: 0,
    _slideOffset: 0,
    _slideStartTimestamp: 0,
    __onTouchMove: function(evt) {
      if(this.fixed) return;
      
      if(evt.changedTouches.length > 1) return; //Cancel if we are touching more than once
      if(!this.sliding && !this._prepareSlide) return;

      if(!this.sliding) {
        if(!this._shouldStartSliding(evt)) return;
        this.sliding = true;
        this._prepareSlide = false;
        this._slidingIn = !this.opened;
        this._slidingOut = this.opened;
        this._slideStartTimestamp = Date.now();
        this._slidePosition = this.opened ? this.paneWidth : -10;
        this._slideOffset = this._slidingOut ? this.paneWidth - this._startTouchX : 0;
        requestAnimationFrame(this._boundRender);
      }
      evt.preventDefault();
      this._slideTargetPosition = evt.changedTouches.item(0).clientX + this._slideOffset;
    }
  };
</script>