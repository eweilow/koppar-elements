<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
    <script src="../bower_components/web-component-tester/browser.js"></script>
    <link rel="import" href="../bower_components/koppar-elements/sidebar/koppar-sidebar.html">
    <style>
      test-fixture {
        position: static;
      }
    </style>
  </head>
  <body>
    <test-fixture id="koppar-sidebar">
      <template>
        <koppar-sidebar></koppar-sidebar>
      </template>
    </test-fixture>
    <script>
      function drag(fromPos, toPos, frames, callback) {
        window.emulatingTouches = true;

        var delta = { x: toPos.x - fromPos.x, y: toPos.y - fromPos.y };
        var velocity = { x: (delta.x / frames), y: (delta.y / frames) };

        // Create the event
        var startEvent = new CustomEvent("touchstart", {
          detail: {
            touches: [
              {
                clientX: fromPos.x,
                clientY: fromPos.y
              }
            ]
          }
        });
        // Dispatch/Trigger/Fire the event
        window.dispatchEvent(startEvent);

        var frameCount = 1;
        function frame() {
          if(frameCount-1 >= frames) {
            clearInterval(interval);
            window.emulatingTouches = false;
            // Create the event
            var endEvent = new CustomEvent("touchend", {
              detail: {
                touches: [
                  {
                    clientX: fromPos.x,
                    clientY: fromPos.y
                  }
                ]
              }
            });
            // Dispatch/Trigger/Fire the event
            window.dispatchEvent(endEvent);

            if(callback) setTimeout(callback, 100);
            return false;
          }
          var detail = {
            changedTouches: {
              length: 1,
              item: function() {
                return {
                  clientX: fromPos.x + velocity.x * frameCount,
                  clientY: fromPos.y + velocity.y * frameCount
                }
              }
            }
          };
          // Create the event
          var event = new CustomEvent("touchmove", {Â detail: detail });
          event.detail = detail;
          // Dispatch/Trigger/Fire the event
          window.dispatchEvent(event);

          frameCount++;
        }
        
        var interval = setInterval(frame, 1000 / 60);
      };
      suite("<koppar-sidebar>", function() {
        var sidebar;
        setup(function() {
          sidebar = fixture("koppar-sidebar");
          sidebar.responsiveBreakpoint = 1000;
        });
        test("Should not be fixed and not open when sidebar.offsetWidth < sidebar.responsiveBreakpoint", function() {
          sidebar.style.width = "999px";

          var event = new Event("resize");
          window.dispatchEvent(event);

          assert.isFalse(sidebar.fixed);
          assert.isFalse(sidebar.opened);
        });
        test("Should not be fixed and not open when sidebar.offsetWidth = sidebar.responsiveBreakpoint", function() {
          sidebar.style.width = "1000px";

          var event = new Event("resize");
          window.dispatchEvent(event);

          assert.isFalse(sidebar.fixed);
          assert.isFalse(sidebar.opened);
        });
        test("Should be fixed and not open when sidebar.offsetWidth > sidebar.responsiveBreakpoint", function() {
          sidebar.style.width = "1001px";

          var event = new Event("resize");
          window.dispatchEvent(event);

          assert.isTrue(sidebar.fixed);
          assert.isFalse(sidebar.opened);
        });

        test("Should open when not fixed", function() {
          sidebar.style.width = "999px";

          var event = new Event("resize");
          window.dispatchEvent(event);

          sidebar.open();
          assert.isFalse(sidebar.fixed);
          assert.isTrue(sidebar.opened);
        });

        test("Should not open when fixed", function() {
          sidebar.style.width = "1001px";

          var event = new Event("resize");
          window.dispatchEvent(event);

          sidebar.open();
          assert.isTrue(sidebar.fixed);
          assert.isFalse(sidebar.opened);
        });

        test("Should close when not fixed and open", function() {
          sidebar.style.width = "999px";

          var event = new Event("resize");
          window.dispatchEvent(event);

          assert.isFalse(sidebar.opened);

          sidebar.open();
          assert.isTrue(sidebar.opened);
          assert.isFalse(sidebar.fixed);

          sidebar.close();
          assert.isFalse(sidebar.opened);
        });

        test("Should close when being fixed", function() {
          sidebar.style.width = "999px";

          var event = new Event("resize");
          window.dispatchEvent(event);

          sidebar.open();
          assert.isFalse(sidebar.fixed);
          assert.isTrue(sidebar.opened);

          sidebar.style.width = "1001px";

          var event = new Event("resize");
          window.dispatchEvent(event);

          assert.isTrue(sidebar.fixed);
          assert.isFalse(sidebar.opened);
        });

        test("Should be draggable", function(callback) {
          sidebar.style.width = "500px";

          sidebar.close();
          assert.isFalse(sidebar.fixed);
          assert.isFalse(sidebar.opened);

          drag({x: 100, y: 200}, {x: 400, y: 200}, 10, function(){
            assert.isTrue(sidebar.opened);
            callback();
          });

        });

        var pairs = [
          { distance: 15, angle: 0, expected: false },
          { distance: 24, angle: 0, expected: false },
          { distance: 50, angle: 0, expected: true },
          { distance: 50, angle: 15, expected: true },
          { distance: 75, angle: 25, expected: true },
          { distance: 75, angle: 35, expected: false },
          { distance: 75, angle: 45, expected: false },
          { distance: 50, angle: -15, expected: true },
          { distance: 75, angle: -25, expected: true },
          { distance: 75, angle: -35, expected: false },
          { distance: 75, angle: -45, expected: false }
        ];

        pairs.forEach(function(pair){
          function run(startX, startY, distance, angle, callback) {
            var radianAngle = angle * (Math.PI / 180);
            var endX = (startX + Math.cos(radianAngle) * distance);
            var endY = (startY + Math.sin(radianAngle) * distance);
            drag({x: startX, y: startY}, {x: endX, y: endY}, 10, function(){
              callback("moving from " + startX + ", "+ startY + " to " + endX + ", " + endY + ", " + radianAngle + "\n" + sidebar._debugSteps.map(function(x){
                return [x.type, x.deltaX.toString(), x.deltaY.toString(), x.angle.toString(), x.length.toString(), x.deltaTime.toString()].join(", ");
              }).join("\n"));
            });
          }
          
          var str = "Should " + (pair.expected ? "": "not") + " open when angle = " + pair.angle + " and distance = " + pair.distance;
          test(str, function(cb){
            sidebar.style.width = "500px";

            sidebar.close();
            assert.isFalse(sidebar.opened, "Should be closed when starting");

            run(100, 200, pair.distance, pair.angle, function(str){
              if(pair.expected) {
                assert.isTrue(sidebar.opened, str);
              } else {
                assert.isFalse(sidebar.opened, str);
              }
              cb();
            });
          });
          var str = "Should " + (pair.expected ? "": "not") + " close when angle = " + pair.angle + " and distance = " + pair.distance;
          test(str, function(cb){
            sidebar.style.width = "500px";

            sidebar.open();
            assert.isTrue(sidebar.opened, "Should be open when starting");

            run(400, 200, -pair.distance, pair.angle, function(str){
              if(pair.expected) {
                assert.isFalse(sidebar.opened, str);
              } else {
                assert.isTrue(sidebar.opened, str);
              }
              cb();
            });
          });
        }.bind(this));
/*
        test("Should only move when angle <= 30 degrees and distance > 25 pixels", function(cb) {

          run(100, 200, 15, 0, function(str){
            assert.isFalse(sidebar.opened, str);
            run(100, 200, 26, 0, function(str){
              assert.isTrue(sidebar.opened, str);
              sidebar.close();
              run(100, 200, 50, 5, function(str){
                assert.isTrue(sidebar.opened, str);
                sidebar.close();
                run(100, 200, 50, 31, function(str){
                  assert.isFalse(sidebar.opened, str);
                  run(100, 200, 50, 29, function(str){
                    assert.isTrue(sidebar.opened, str);
                    cb();
                  });
                });
              });
            });
          });
        });*/
      });
      a11ySuite("koppar-sidebar");
    </script>

  </body>
</html>